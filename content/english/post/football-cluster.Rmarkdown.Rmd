---
title: "Expenses"
author: "Axel-Cleris Gailloty"
date: "26/05/2019"
output:
  html_document:
    toc : true
---

```{r, message=FALSE, warning = FALSE}
# Load the packages 
library(tidyverse)
library(FactoMineR)
library(factoextra)
library(highcharter)
library(ggthemes)
library(lubridate)
library(treemap)
```
This kernel is under construction :) !  

# Reading and preparing the data

```{r, message=FALSE, warning=FALSE}
fifa <- read_csv("data.csv")
print(paste("The dataset contains", dim(fifa)[1], "observations and", dim(fifa)[2], "columns"))
```

## Missing values

With this said let's check the consistency of the dataset by looking for missing values and understanding what each column stands for.

```{r, fig.height=11, fig.width = 8}
theme_set(theme_economist())
map_dbl(fifa, function(x) sum(is.na(x))/length(x)*100) %>%
  stack() %>%
  ggplot(aes(x = reorder(ind,values), y = values)) + 
  geom_bar(stat = 'identity') + coord_flip() +
  labs(y = "% of missing values", x = "Columns", title = "Missing values")
```

The loaned from column contains lots of missing values. All the other columns have between 0 and 10% missing values. Overall the dataset contains few missing values.

## Columns content

```{r}
knitr::kable(head(fifa))
```

### Value and wage columns 

```{r}
glimpse(fifa[c("Value", "Wage")])
```

Because of their formats `€-NUM-M/K`, R doesn't read them properly. We need to do some string manipulations in order to convert them into numerical columns so we can use later in the analysis.  
Let's start by removing the `€`symbols in both columns.

```{r, warning=FALSE}
fifa <- fifa %>% mutate(Value = str_replace(Value, "€", ""),
                Wage = str_replace(Wage, "€", ""))
```

Now since since the `Value` column is not always in million € we need to separate each element of it into two columns `raw_value` and `unit` that will hold the amount and the unit (millions (M) or thousands(K))

```{r}
fifa %>% separate(Value, into = c("raw_value", "unit_value"), sep = "(?=[:LETTER:])") %>%
  select(raw_value, unit_value) %>% group_by(unit_value) %>% summarize(count = n())
```

As we can see here, there a fewer players who are worth million. Let's save it and do the same for the Wage column.
```{r, warning=FALSE, message=FALSE}
fifa <- fifa %>% separate(Value, into = c("raw_value", "unit_value"), sep = "(?=[:LETTER:])")
```


```{r, warning=FALSE, message=FALSE}
fifa %>% separate(Wage, into = c("raw_wage", "unit_wage"), sep = "(?=[:LETTER:])") %>%
  select(raw_wage, unit_wage) %>% group_by(unit_wage) %>% summarize(count = n())
```

All the values of this column are expressed in thousands. So we can keep it as it is.  

Now let's convert them into numerical values. We will convert the millions that are in the `Value` column into thousands(K) so that each observation has the same unit.  

```{r, warning=FALSE}
# Converting into numerical columns
fifa <- fifa %>% mutate(value_k = as.numeric(raw_value)) 
# Convert it into thousands
fifa <- fifa %>% mutate(value_k = ifelse(unit_value == "M", value_k * 1000, value_k))
fifa <- fifa %>% mutate(Wage = str_replace(Wage, "K",""), Wage = as.numeric(Wage))
```

## Date columns

```{r}
glimpse(fifa[c("Joined", "Contract Valid Until")])
```
```{r, warning=FALSE}
fifa <- fifa %>% rename(Contract_Validity = `Contract Valid Until`) %>%
  mutate(Joined = mdy(Joined), 
                Contract_Validity = ymd(Contract_Validity, truncated = 2L))
```

# Exploratory Data Analysis

## Visualizations 
### Value distribution

```{r, message=FALSE}
fifa %>% filter(value_k < 1000) %>%
  ggplot(aes(x = value_k)) + geom_histogram(size = 1.2, fill = "lightblue", color = 'black') +
  labs(title = "Value distribution of players < million ", x = "Value in K €")
```
```{r, message=FALSE}
fifa %>% filter(value_k > 1000) %>%
  ggplot(aes(x = value_k)) + geom_histogram(size = 1.2, fill = "lightblue", color = 'black') +
  labs(title = "Value distribution of players >  1 million", x = "Value in €")
```

## Distribution of wage
```{r, warning=FALSE}
fifa %>% filter(Wage < 100) %>%
  ggplot(aes(x = Wage)) + geom_histogram(size = 1.2, fill = "lightblue", color = 'black') + labs(title = "Distribution of wage < 100k €")
```

```{r, warning=FALSE}
fifa %>% filter(Wage > 100) %>%
  ggplot(aes(x = Wage)) + geom_histogram(size = 1.2, fill = "lightblue", color = 'black') + labs(title = "Distribution of wage > 100k €")
```
### Correlation between wage and value

```{r, warning=FALSE}
fifa %>%
  ggplot(aes(x = value_k, y = Wage)) +
  geom_point(alpha = 1/3) + labs(title = "Correlation between value and wage", x = "Value (in thousands €)")
```

## Time spent in current club
```{r}
fifa <- fifa %>% 
  mutate(months_in_current_club = interval(Joined, ymd(2019, truncated = 2L))/months(1))
```

### Link between time spent in current club and wage
```{r, warning=FALSE}
fifa %>%
  ggplot(aes(x = months_in_current_club, y = Wage)) +
  geom_point() + labs(x = "Number of months", y = "Wage (thousands €)")
```

There is not obvious relationship between time spent in a club and the wage. 

## What are the top nationality of the players

```{r}
fifa %>% group_by(Nationality) %>%
  summarize(count = n()) %>%
  treemap(index = "Nationality", vSize = "count", title = "Nationality of players")
```

This quite interesting. Out of the Fist five nationalities, 4 are European countries. Football is really popular in Europe in Europe.

## Which clubs have the highest spendings for their players

```{r, fig.height = 10}
fifa %>%
  group_by(Club) %>% summarize(spending = sum(Wage)) %>% top_n(35) %>%
  ggplot(aes(y = spending, x = reorder(Club, spending))) + 
           geom_bar(stat = "identity") + coord_flip() + 
  labs(y = "Total wages (in thousands €)", x = "Clubs", title = "Clubs spendings in wages")
```

# Cluster Analysis

In this section we want to study how can we gather the players based on their characteristics. We will use all the technical columns.

```{r, message=FALSE, warning=FALSE}
library(FactoMineR)
library(factoextra)
```

Since I am not a football professional I'm going to use the columns that mean something in this cluster analysis.
Let's select the columns


```{r}
pca_data <- fifa[c(3:4,56:89)]
```
```{r}
# Remove duplicate players
pca_data <- pca_data %>% filter(!duplicated(Name))
```

Clean the missing values

```{r}
pca_data <- na.omit(pca_data)
pca_data <- data.frame(pca_data, row.names = 1)
```

```{r}
knitr::kable(head(pca_data))
```


```{r message=FALSE, warning=FALSE}
pca <- PCA(pca_data, quanti.sup = 1)
```

Let's now try to see how correlated are the variables and discover how they separate the players.

```{r, fig.width=8, fig.height=8}
fviz_pca_var(pca, repel = T) + theme_economist()
```

```{r}
fviz_pca_contrib(pca, choice = "var")
```

```{r}
fviz_pca_contrib(pca, choice = "var", axes = 2)
```


```{r}
fviz_pca_ind(pca, geom = "point", alpha.ind = "contrib", addEllipses = T) + theme_economist()
```

```{r}
fviz_pca_ind(pca, geom = "text", 
             select.ind = list(name = c("L. Messi", 
                                        "Cristiano Ronaldo", "Neymar Jr", "E. Hazard"))) + 
  theme_economist()
```

